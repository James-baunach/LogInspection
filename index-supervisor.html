<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Dashboard</title>
    <link rel="stylesheet" href="supervisor.style.css">
    <!-- Supabase library loaded first in HEAD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- supervisor.app.js will be loaded and initialized at the end of the body -->
</head>
<body>
    <h1>Supervisor Dashboard</h1>

    <div id="supervisorAuthSection">
        <h2>Supervisor Login</h2>
        <input type="email" id="supervisorEmail" placeholder="Supervisor Email (e.g., admin@...)" required><br>
        <input type="password" id="supervisorPassword" placeholder="Password" required><br>
        <button id="supervisorLoginBtn">Login</button>
        <p id="supervisorAuthStatus"></p>
    </div>

    <div id="supervisorMainContent" class="hidden">
        <p>Logged in as: <span id="supervisorUserEmail"></span> <button id="supervisorLogoutBtn">Logout</button></p>
        <hr>
        <h2>Inspections Overview</h2>
        <button id="refreshBtn">Refresh List</button>
        <div id="loadingStatus">Loading inspections...</div>
        <table id="inspectionsTable">
            <thead>
                <tr>
                    <th>Project #</th>
                    <th>Insp. Date</th>
                    <th>County</th>
                    <th>Lat/Lon</th>
                    <th>Logger</th>
                    <th>Acreage</th>
                    <th>BMPs Met?</th>
                    <th>Map</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inspectionsTableBody">
                <!-- Data rows will be added here -->
            </tbody>
        </table>
    </div>

    <dialog id="editModal">
        <form id="editForm">
            <h2>Edit Inspection & Project Details</h2>
            <input type="hidden" id="editInspectionId">
            <input type="hidden" id="editProjectId">

            <fieldset>
                <legend>Project Details (Editable)</legend>
                <label for="editProjectNumber">Project Number:</label>
                <input type="text" id="editProjectNumber" required><br>

                <label for="editLatitude">Latitude:</label>
                <input type="number" step="any" id="editLatitude" required><br>

                <label for="editLongitude">Longitude:</label>
                <input type="number" step="any" id="editLongitude" required><br>
            </fieldset>
            <hr>
            <fieldset>
                <legend>Inspection Details (Editable)</legend>
                <label for="editLoggerName">Logger Name:</label>
                <input type="text" id="editLoggerName" required><br>

                <label for="editAcreage">Acreage:</label>
                <input type="number" step="0.1" id="editAcreage" required><br>

                <label for="editInspectionDate">Inspection Date/Time:</label>
                <input type="datetime-local" id="editInspectionDate" required><br>

                <fieldset class="inner-fieldset">
                    <legend>BMPs Met?</legend>
                    <label><input type="radio" name="editBmpsMet" value="true" required> Yes</label>
                    <label><input type="radio" name="editBmpsMet" value="false"> No</label>
                </fieldset>

                <label for="editNotes">Notes:</label><br>
                <textarea id="editNotes" rows="3"></textarea><br>

                <p><strong>Map Image:</strong>
                    <a id="editMapLink" href="#" target="_blank" rel="noopener noreferrer">View Current Map</a>
                    <span id="noMapText" class="hidden">(No map uploaded)</span>
                </p>
            </fieldset>

            <div class="modal-actions">
                <button type="submit" id="saveEditBtn">Save Changes</button>
                <button type="button" id="cancelEditBtn">Cancel</button>
            </div>
            <div id="editStatus"></div>
        </form>
    </dialog>

    <!-- Script to load and initialize supervisor.app.js -->
    <script>
        function initializeSupervisorApp() {
            // This function will be defined in supervisor.app.js
            // and will contain all the code that is currently at the global scope in that file.
            if (typeof window.runSupervisorApp === 'function') {
                console.log('Attempting to run Supervisor App initialization...');
                window.runSupervisorApp();
            } else {
                console.error('runSupervisorApp function not found. supervisor.app.js might not have loaded correctly or is missing the function.');
            }
        }

        // Dynamically load supervisor.app.js
        const supervisorScript = document.createElement('script');
        supervisorScript.src = 'supervisor.app.js';
        supervisorScript.onload = initializeSupervisorApp; // Call initialize AFTER script is loaded
        supervisorScript.onerror = function() {
            console.error('Failed to load supervisor.app.js');
        };
        document.body.appendChild(supervisorScript);
    </script>
</body>
</html>
